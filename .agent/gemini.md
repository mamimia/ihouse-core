# iHouse Core Constitution (gemini.md)

## 1. System Identity
Hybrid Property Driven with Booking Triggered Task Engine.
Multi tenant.
Bilingual UI: English main, Thai secondary.

## 2. Non Negotiable Invariants
1. Every state change writes an audit event.
2. Logs are immutable. No deletion.
3. Redaction is allowed only for sensitive media. Event record remains.
4. External platforms are authoritative for booking timeframes.
5. No silent override. Any conflict requires an explicit decision and is logged.
6. No cross company visibility.
7. Critical protection is always active. It cannot be fully disabled.

## 3. Entity IDs & Company Join & Invite Policy (Auth Gate)

## 3.1 Goals
1. No public signup.
2. Allow field onboarding without admin typing everything.
3. Prevent cross-company mis-joins and spam.
4. Every auth/admin action is auditable.

## 3.2 Entry Points
A. Invite Link (Admin initiated)
B. Request Access (Employee initiated)

## 3.3 Company Codes (Option C)
1. Company has a Permanent Join Code:
   - `company_join_code_static`
   - May be rotated by Admin (manual)
2. Company can generate One Time Join Codes:
   - `company_join_code_otp`
   - Single use OR expires (default 24h)
   - Generated by Admin only
3. Any Request Access must include one of:
   - Static code OR one time code OR QR that encodes one of them

## 3.4 Request Access Flow (Employee initiated)
1. Employee enters:
   - Join code (static or one time) OR scans QR
   - Email
   - Full name
   - Phone optional
2. System sends Email OTP to verify email ownership.
3. Only after OTP verification:
   - Create `AccessRequest` in status `Pending`
   - Notify Admin + Operational Manager (configurable)
4. Admin actions:
   - Approve -> create User, assign Company + Role, optional permissions, send Set Password link
   - Reject -> close request, log reason
5. No access is granted before approval.

## 3.5 Invite Link Flow (Admin initiated)
1. Admin creates User draft:
   - Email required
   - Role required
   - Optional: phone, nickname, emergency contact
2. System sends Invite Link:
   - Link is single use OR expires (default 72h)
3. Employee opens link -> verifies email (OTP) -> sets password -> account activated

## 3.6 Roles & Permissions at Onboarding
1. Default role is selected by Admin on approval/invite.
2. Operational Manager can approve requests only if Admin granted `can_approve_access_requests`.
3. Booking override permission is explicit:
   - `can_booking_override`
   - If not granted, Operational Manager may submit override request which remains Pending until Admin approval.

## 3.7 Audit Requirements (Non negotiable)
Every event must write audit:
1. AccessRequest created
2. Email OTP sent / verified / failed
3. Admin approval / rejection + reason
4. Invite link generated / opened / expired
5. Join code rotated
6. One time code generated / used / expired
7. Role / permission assigned or changed

## 3.8 Minimum Schemas (New Entities)
AccessRequest:
- access_request_uuid
- company_uuid (resolved from join code)
- requested_email
- requested_full_name
- requested_phone optional
- status: Pending | Approved | Rejected | Expired
- created_at
- resolved_at optional
- resolved_by_user_uuid optional
- resolution_note optional

Company Join Code:
- company_uuid
- join_code_static_hash
- static_rotated_at
- OneTimeCode:
  - code_uuid
  - code_hash
  - expires_at
  - used_at optional
  - used_by_email optional

Invite:
- invite_uuid
- company_uuid
- email
- role
- expires_at
- used_at optional

## 4. Status Model (Property State)
Allowed states:
1. Available
2. Occupied
3. Cleaning
4. Ready
5. AtRisk
6. Blocked
7. Archived

Rules:
1. Ready means: cleaning task completed AND required photos uploaded AND checklist completed.
2. If a Normal issue exists, property may remain Ready OR move to AtRisk depending on timing and category.
3. If a Critical issue exists, property state must be Blocked immediately.
4. Archived means: inactive and queryable, cannot accept new bookings, can be unarchived by Admin.

## 4.1 Priority Stack
1. Blocked overrides all states and timelines.
2. Critical issue overrides Ready and Cleaning.
3. AtRisk overrides Ready.
4. Occupied overrides Available and Ready.
5. Archived overrides all and blocks new bookings.
UI must always render the highest priority state.

## 5. Issue Severity
Only two severities:
1. Normal
2. Critical

Mapping:
1. Normal does not automatically block check-in. It can trigger AtRisk.
2. Critical forces Blocked and immediate escalation.

## 6. Roles
1. Admin
2. OperationalManager
3. Cleaner
4. CheckInStaff
5. Maintenance

## 7. Permission Flags
All flags default to false.
Admin controls flags per user.

OperationalManager flags:
1. can_booking_override

## 8. Booking Source of Truth
Source hierarchy:
1. Airbnb
2. BookingCom
3. DirectBooking

Rule:
External wins on timeframes.

Conflict handling (External overlap with DirectBooking):
1. Mark DirectBooking as PendingResolution.
2. Set Property state to AtRisk.
3. Create ConflictTask assigned to OperationalManager.
4. Escalate to Admin if not acknowledged within SLA.
5. No automatic cancellation of external booking.
6. Resolution requires explicit human action and audit log.

## 9. Booking Lifecycle
Booking states:
1. Scheduled
2. InStay
3. Completed
4. Cancelled
5. PendingResolution

Transitions:
1. Scheduled → InStay at check-in completion
2. InStay → Completed at check-out completion
3. Any → PendingResolution on conflict
4. Any → Cancelled only via Admin explicit action or external cancellation event

## 10. Task Engine Core Types
Task types:
1. CleaningTask
2. CheckOutTask
3. CheckInTask
4. MaintenanceTask
5. IssueTask
6. ConflictTask
7. RelocationTask

Task status:
1. Created
2. Assigned
3. Acknowledged
4. InProgress
5. Completed
6. Escalated
7. Cancelled

## 11. Escalation Policy
Each Company must choose one:
1. Strict
2. Default
3. Relaxed

Critical SLA (non configurable):
1. Critical acknowledgement SLA: 5 minutes

Normal SLA (configurable within safe bounds):
1. Normal acknowledgement SLA default: 20 minutes
2. Normal action SLA defaults vary by policy mode

Ack vs Action:
1. Acknowledgement does NOT stop Action SLA
2. InProgress transition is required to stop initial Action timer

## 12. Location and Navigation
Property must include:
1. location_lat
2. location_lng
3. location_label
4. google_maps_place_id optional

UI requirement:
Navigate button must exist in:
1. Property details
2. Task details
3. Staff task view

It must open:
Google Maps and Apple Maps.

## 13. Media Rules
Media categories:
1. ReferencePhotos
2. CleaningPhotos
3. CheckInPhotos
4. CheckOutPhotos
5. PassportImages
6. IssueEvidence

Visibility:
1. PassportImages visible to Admin only.
2. All other media visible to Admin and OperationalManager.
3. Staff (Cleaner, CheckInStaff, Maintenance) can view only their own uploaded media for active tasks.
4. After task completion, staff loses access to that task media. Admin retains access.

Retention:
1. PassportImages default 90 days, extendable by Admin.
2. Other media retained with logs, redaction allowed if needed.

## 14. Property Profile Schema (Minimum)
Property fields:
1. property_uuid
2. property_display_id
3. company_uuid
4. name
5. location_text
6. bedrooms_count
7. has_pool
8. deposit_required
9. deposit_amount optional
10. internet_wifi_name
11. internet_wifi_password
12. guest_message_templates for Line, Telegram, WhatsApp (EN + TH)
13. reference_photo_set required per room and key areas
14. archive_state boolean

## 15. Audit Event Schema (Minimum)
AuditEvent fields:
1. audit_uuid
2. company_uuid
3. entity_type
4. entity_uuid
5. action
6. previous_state optional
7. new_state optional
8. triggered_by_role
9. triggered_by_user_uuid optional
10. created_at
11. notes optional
12. redaction_flag optional

## 16. Event Timing Rules
1. Every operational event must store:
   event_occurred_at (when it happened)
   event_received_at (when system received it)
2. SLA timers start at event_received_at.
3. UI must display both when delay exceeds 5 minutes.
4. Audit entry must include delay_seconds when applicable.

